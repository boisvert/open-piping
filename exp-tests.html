<!doctype html>
<meta charset="utf-8" />

<head>

<!-- Dependencies are as follows
   * jquery 3.2.1
   * jquery UI 1.12.1 - js and css
   * jsplumb 2.1.8

   Later versions are probably compatible, but this code is not compatible with
   jsPlumb 2.2.x and above as it stands.
   
   The commented links are to use dependencies from a shared repository. Alternatively, host a copy of them.
-->

<!--script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script-->
<!--script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script-->
<script src="../libraries/jquery.min.js"></script>
<script src="../libraries/jquery-ui.min.js"></script>

<!-- jsPlumb version: the code is incompatible version versions 2.2.x - endPoints not showing -->
<!--script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.1.8/jsPlumb.min.js"></script-->
<script src="../libraries/jsPlumb.2.1.8.min.js"></script>

<script src="compile_workflow.js"></script>
    
<title>Edit and interpret a workflow</title>

<!-- link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" -->

<link rel="stylesheet" href="../libraries/jquery-ui.min.css">

</head>

<body>

<h1>Open piping: lowering the barriers to data science</h1>

<h2>Test page. Interpret a symbolic expression into a function call and function set</h2>

Project:
  <a href="index.html">programming</a> | Github:
  <a href="https://github.com/boisvert/open-piping">code</a> |
  <a href="https://github.com/boisvert/open-piping/wiki">wiki</a> | 
  <a href="https://github.com/boisvert/open-piping/issues">issues</a>
<p>

<form>
<select onChange="inject(this.selectedIndex-1)">
  <option value="choose">Try one of the ready-made tests:</option>
  <option value="0">Number</option>
  <option value="1">Simple list</option>
  <option value="2">Booleans</option>
  <option value="3">Function substitution</option>
  <option value="4">Defun</option>
  <option value="5">Defun recursive (fatorial)</option>
  <option value="6">Higher order function (map)</option>
</select>
<br />
<textarea id="s-exp" cols="80" rows="10"></textarea>
<br />
Language:
<select id="chooseLang" onChange = "getCode();">
<option value="JS" selected>JS</option>
<option value="PHP">PHP</option>
</select>
<input type="button" value="Show result" onClick="runres();" /> <br />

<textarea id="result" cols="80" rows="10">
</textarea>

</form>

<script>

var predefined_functions = {},
    predefined_replacements = {};

$(loadDefinitions);

function loadDefinitions() {
	$.ajax({
		url: "js_blocks.json",
		beforeSend: function(xhr){
			if (xhr.overrideMimeType) {
				xhr.overrideMimeType("application/json");
			}
		},
		success: function(json) {
			predefined_functions = json.functions;
			predefined_replacements = json.replace;
		},
		error: function(_, status, err) {debugMsg(status+'\n'+err);}
	});
}

// show sample of code
function inject(num) {
   if (num>=0) {
	   var samples = [
		  '1',
		  '[1, 2, 3, "a", "b", "c"]',
		  '["or",["isNumber", 3], ["isNumber", "a"]]',
		  '["plus", 1, 2]',
		  '[\n "defun", "square", ["x"], ["times", "x", "x"],\n  ["square", 2] \n]',
		  '[\n "defun", "fac", ["n"], ["if", ["lt", "n", 2], 1, ["times", "n", ["fac", ["minus", "n", 1]] ]],\n  [ "fac", 10 ]\n]',
		  '[\n  "defun", "map", ["f", "arr"], ["if", ["isEmpty", "arr"], [], ["cons", ["apply", "f", [["first", "arr"]] ], ["map", "f", ["rest", "arr"] ] ]\n],\n  ["map", "\\\\isNumber", [1,2,3,"a","b","c"] ] \n]',
	   ];
	   $('#s-exp').val(samples[num]);
	   getCode();
   }
}

// compile event

// compile
function getCode() {
	var lang = $('#chooseLang').val();
    var exp = $('#s-exp').val();
    chooseCompiler(exp,lang,function( res ) {$('#result').val(res);});
}

function chooseCompiler(Exp,lang,callBack) {
	debugMsg("compiling in",lang);
    if (lang==='JS') {
		callBack(compile(JSON.parse(Exp)));
    }
    else if(lang==='PHP') {
		Exp = encodeURIComponent(Exp);
        $.post('compile_workflow.php', 'exp='+Exp).done(callBack);
    }
}

// run result
function runres() {
   var c = $('#result').val();
   eval(c);
   alert(pipe());
}

</script>
</body>
</html>
